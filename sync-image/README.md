
# Dockeré•œåƒåŒæ­¥å·¥å…· ğŸ³

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„Dockeré•œåƒåŒæ­¥è„šæœ¬ï¼Œæ”¯æŒä»Harborä»“åº“æ‰¹é‡åŒæ­¥é•œåƒåˆ°æœ¬åœ°Registryã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **æ‰¹é‡åŒæ­¥**ï¼šæ”¯æŒä»é•œåƒæ¸…å•æ–‡ä»¶æ‰¹é‡åŒæ­¥é•œåƒ
- ğŸ”„ **è‡ªåŠ¨é‡è¯•**ï¼šå†…ç½®é‡è¯•æœºåˆ¶ï¼Œæé«˜åŒæ­¥æˆåŠŸç‡
- ğŸ“Š **è¿›åº¦æ˜¾ç¤º**ï¼šå®æ—¶æ˜¾ç¤ºåŒæ­¥è¿›åº¦å’Œç»Ÿè®¡ä¿¡æ¯
- ğŸ“ **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- ğŸ¨ **å½©è‰²è¾“å‡º**ï¼šå‹å¥½çš„å½©è‰²ç»ˆç«¯è¾“å‡º
- âš™ï¸ **çµæ´»é…ç½®**ï¼šæ”¯æŒå‘½ä»¤è¡Œå‚æ•°è‡ªå®šä¹‰é…ç½®
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤æœºåˆ¶
- ğŸ“‹ **å¼ºåˆ¶æ›´æ–°**ï¼šé»˜è®¤å¼ºåˆ¶åŒæ­¥æ‰€æœ‰é•œåƒï¼Œç¡®ä¿è·å–æœ€æ–°ç‰ˆæœ¬
- ğŸ—ï¸ **å¤šæ¶æ„æ”¯æŒ**ï¼šè‡ªåŠ¨åŒæ­¥æ‰€æœ‰æ¶æ„çš„é•œåƒï¼ˆamd64ã€arm64ç­‰ï¼‰

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- Linux/macOS ç³»ç»Ÿ
- Bash 4.0+
- [skopeo](https://github.com/containers/skopeo) å·¥å…·

### å®‰è£… skopeo

```bash
# Ubuntu/Debian
sudo apt-get update && sudo apt-get install skopeo

# CentOS/RHEL
sudo yum install skopeo

# macOS
brew install skopeo
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```bash
# è¿›å…¥è„šæœ¬ç›®å½•
cd sync-image

# ä½¿ç”¨é»˜è®¤é…ç½®åŒæ­¥é•œåƒ
./sync-images.sh
```

### 2. è‡ªå®šä¹‰é…ç½®

```bash
# æŒ‡å®šé•œåƒæ¸…å•æ–‡ä»¶
./sync-images.sh -f custom-imgs.txt

# æŒ‡å®šæºå’Œç›®æ ‡ä»“åº“
./sync-images.sh -s harbor.example.com -t localhost:5000

# è®¾ç½®é‡è¯•å‚æ•°
./sync-images.sh -r 5 -d 10
```

## ğŸ“– è¯¦ç»†ç”¨æ³•

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é•¿å‚æ•° | æè¿° | é»˜è®¤å€¼ |
|------|--------|------|--------|
| `-f` | `--file` | é•œåƒæ¸…å•æ–‡ä»¶è·¯å¾„ | `imgs.txt` |
| `-s` | `--source` | æºä»“åº“åœ°å€ | `registry.bingosoft.net` |
| `-t` | `--target` | ç›®æ ‡ä»“åº“åœ°å€ | `127.0.0.1:5000` |
| `-r` | `--retries` | æœ€å¤§é‡è¯•æ¬¡æ•° | `3` |
| `-d` | `--delay` | é‡è¯•å»¶è¿Ÿ(ç§’) | `5` |
| `-h` | `--help` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | - |

### é•œåƒæ¸…å•æ–‡ä»¶æ ¼å¼

é•œåƒæ¸…å•æ–‡ä»¶ (`imgs.txt`) æ ¼å¼è¯´æ˜ï¼š

```bash
# è¿™æ˜¯æ³¨é‡Šè¡Œï¼Œä¼šè¢«å¿½ç•¥
registry.bingosoft.net/namespace/image:tag

# æ”¯æŒåˆ†ç»„æ³¨é‡Š
# base images
registry.bingosoft.net/bingokube/cluster-image/k8s-containerd:v1.6.0-gkd
registry.bingosoft.net/bingokube/cluster-image/helm:v1.0.1

# å¯ä»¥ç”¨ # æ³¨é‡Šæ‰ä¸éœ€è¦åŒæ­¥çš„é•œåƒ
#registry.bingosoft.net/bingokube/cluster-image/etcd-cluster:v1.0.0

# expansion images
registry.bingosoft.net/bingokube/cluster-image/harbor:v1.0.1-gkd-0725
```

**æ ¼å¼è§„åˆ™ï¼š**
- æ¯è¡Œä¸€ä¸ªå®Œæ•´çš„é•œåƒåœ°å€ï¼ˆåŒ…å«ä»“åº“åœ°å€ã€å‘½åç©ºé—´ã€é•œåƒåå’Œæ ‡ç­¾ï¼‰
- ä»¥ `#` å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Šï¼Œä¼šè¢«å¿½ç•¥
- ç©ºè¡Œä¼šè¢«å¿½ç•¥
- æ”¯æŒè¡Œå†…æ³¨é‡Š

## ğŸ“Š è¾“å‡ºè¯´æ˜

### åŒæ­¥è¿‡ç¨‹è¾“å‡º

```bash
==========================================
    Dockeré•œåƒåŒæ­¥è„šæœ¬ v1.0.0
==========================================

2024-01-15 10:30:00 [INFO] é…ç½®ä¿¡æ¯:
2024-01-15 10:30:00 [INFO]   æºä»“åº“: registry.bingosoft.net
2024-01-15 10:30:00 [INFO]   ç›®æ ‡ä»“åº“: 127.0.0.1:5000
2024-01-15 10:30:00 [INFO]   é•œåƒæ¸…å•: imgs.txt
2024-01-15 10:30:00 [INFO]   æœ€å¤§é‡è¯•: 3
2024-01-15 10:30:00 [INFO]   é‡è¯•å»¶è¿Ÿ: 5ç§’
2024-01-15 10:30:00 [INFO]   æ—¥å¿—æ–‡ä»¶: sync-20240115_103000.log

2024-01-15 10:30:01 [INFO] æ£€æŸ¥ä¾èµ–å·¥å…·...
2024-01-15 10:30:01 [SUCCESS] ä¾èµ–æ£€æŸ¥å®Œæˆ
2024-01-15 10:30:01 [INFO] å‘ç° 25 ä¸ªé•œåƒéœ€è¦åŒæ­¥
2024-01-15 10:30:01 [INFO] å¼€å§‹åŒæ­¥é•œåƒ...

è¿›åº¦: [=========================-------------------------] 50% (12/25)

2024-01-15 10:30:15 [SUCCESS] åŒæ­¥æˆåŠŸ: registry.bingosoft.net/bingokube/cluster-image/helm:v1.0.1 -> 127.0.0.1:5000/bingokube/cluster-image/helm:v1.0.1
```

### ç»Ÿè®¡ä¿¡æ¯è¾“å‡º

```bash
2024-01-15 10:35:00 [INFO] ========== åŒæ­¥ç»Ÿè®¡ ==========
2024-01-15 10:35:00 [INFO] æ€»é•œåƒæ•°: 25
2024-01-15 10:35:00 [SUCCESS] æˆåŠŸåŒæ­¥: 23
2024-01-15 10:35:00 [WARNING] è·³è¿‡é•œåƒ: 1
2024-01-15 10:35:00 [ERROR] å¤±è´¥é•œåƒ: 1
2024-01-15 10:35:00 [INFO] æ—¥å¿—æ–‡ä»¶: sync-20240115_103000.log
```

## ğŸ“ æ—¥å¿—æ–‡ä»¶

è„šæœ¬ä½¿ç”¨å›ºå®šçš„æ—¥å¿—æ–‡ä»¶ `sync-images.log`ï¼Œæ¯æ¬¡è¿è¡Œä¼šè¿½åŠ æ–°çš„æ—¥å¿—å†…å®¹ã€‚

æ—¥å¿—åŒ…å«ï¼š
- è¯¦ç»†çš„åŒæ­¥è¿‡ç¨‹è®°å½•
- é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
- skopeo å‘½ä»¤çš„è¯¦ç»†è¾“å‡º
- æ—¶é—´æˆ³å’Œæ—¥å¿—çº§åˆ«

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **skopeo æœªå®‰è£…**
   ```bash
   ERROR: skopeo æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… skopeo
   ```
   è§£å†³ï¼šæŒ‰ç…§ä¸Šè¿°å®‰è£…è¯´æ˜å®‰è£… skopeo

2. **é•œåƒæ¸…å•æ–‡ä»¶ä¸å­˜åœ¨**
   ```bash
   ERROR: é•œåƒæ¸…å•æ–‡ä»¶ imgs.txt ä¸å­˜åœ¨
   ```
   è§£å†³ï¼šç¡®ä¿é•œåƒæ¸…å•æ–‡ä»¶å­˜åœ¨ä¸”è·¯å¾„æ­£ç¡®

3. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```bash
   ERROR: åŒæ­¥å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°
   ```
   è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿èƒ½è®¿é—®æºå’Œç›®æ ‡ä»“åº“

4. **æƒé™é—®é¢˜**
   ```bash
   ERROR: unauthorized: authentication required
   ```
   è§£å†³ï¼šé…ç½®ä»“åº“è®¤è¯ä¿¡æ¯æˆ–ä½¿ç”¨ `--src-creds` å’Œ `--dest-creds` å‚æ•°

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†è¾“å‡ºè¿›è¡Œè°ƒè¯•ï¼š

```bash
# å¯ç”¨ bash è°ƒè¯•æ¨¡å¼
bash -x ./sync-images.sh

# æˆ–è€…ä¿®æ”¹è„šæœ¬ç¬¬ä¸€è¡Œ
#!/bin/bash -x
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘åŒæ­¥

å¯¹äºå¤§é‡é•œåƒï¼Œå¯ä»¥è€ƒè™‘å¹¶å‘åŒæ­¥ï¼ˆéœ€è¦ä¿®æ”¹è„šæœ¬ï¼‰ï¼š

```bash
# ç¤ºä¾‹ï¼šå¹¶å‘åŒæ­¥ï¼ˆéœ€è¦è‡ªè¡Œå®ç°ï¼‰
sync_image "${line}" &
if (( $(jobs -r | wc -l) >= 5 )); then
    wait -n  # ç­‰å¾…ä»»æ„ä¸€ä¸ªåå°ä»»åŠ¡å®Œæˆ
fi
```

### ç½‘ç»œä¼˜åŒ–

- ä½¿ç”¨æœ¬åœ°ç½‘ç»œçš„ä»“åº“å¯ä»¥æ˜¾è‘—æé«˜åŒæ­¥é€Ÿåº¦
- è€ƒè™‘ä½¿ç”¨ CDN æˆ–é•œåƒåŠ é€Ÿå™¨
- è°ƒæ•´é‡è¯•å‚æ•°ä»¥é€‚åº”ç½‘ç»œç¯å¢ƒ

## ğŸ”— ç›¸å…³é“¾æ¥

- [skopeo å®˜æ–¹æ–‡æ¡£](https://github.com/containers/skopeo)
- [Docker Registry API](https://docs.docker.com/registry/spec/api/)
- [Harbor æ–‡æ¡£](https://goharbor.io/docs/)
3. harboråŸŸåï¼šregistry.bingosoft.netã€æœ¬åœ°ä»“åº“ï¼š127.0.0.1:5000
