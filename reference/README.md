# 参考资源说明

> 本目录包含用于学习和参考的脚本示例和函数库。

## 目录结构

```
reference/
├── README.md              # 本文档
├── lib/                   # 参考函数库
│   └── common.sh          # 通用工具函数示例
├── kubernetes/            # Kubernetes 脚本示例
└── k3s/                   # k3s 脚本示例
```

## 重要说明

⚠️ **这些是参考资源，不是共享库！**

- **不要直接 source 这些文件**
- **应该复制需要的函数到你的子项目中**
- **子项目应该是独立的、自包含的**

## 参考函数库（lib/common.sh）

### 概述

`lib/common.sh` 提供了 15+ 个常用工具函数的示例实现，涵盖：

- 📝 **日志系统**：分级日志输出
- 🖥️ **平台检测**：操作系统和架构检测
- 🔄 **重试机制**：自动重试失败的命令
- ✅ **工具检查**：验证必需工具是否存在
- 📁 **文件操作**：目录创建、路径处理
- 🧹 **临时目录管理**：自动创建和清理
- 🔗 **Trap 管理**：多个 trap 处理器
- 🌐 **网络工具**：URL 响应等待
- 🔢 **版本比较**：语义化版本比较

### 如何使用

**步骤 1**：查看函数实现

```bash
# 查看 common.sh 中的所有函数
cat reference/lib/common.sh
```

**步骤 2**：复制需要的函数到你的脚本

```bash
# 示例：复制日志函数
function log_info() {
    echo "[INFO] $*"
}

function log_error() {
    echo "[ERROR] $*" >&2
}
```

**步骤 3**：根据需要调整函数

```bash
# 可以根据你的需求修改函数实现
function log_info() {
    local timestamp
    timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    echo "[${timestamp}] [INFO] $*"
}
```

### 函数列表

#### 日志函数

| 函数 | 用途 | 示例 |
|------|------|------|
| `log_info` | 信息日志 | `log_info "处理完成"` |
| `log_error` | 错误日志 | `log_error "文件不存在"` |
| `log_warn` | 警告日志 | `log_warn "使用默认配置"` |
| `log_debug` | 调试日志 | `DEBUG=1 script.sh` |
| `log_verbose` | 详细日志 | `VERBOSE=1 script.sh` |
| `log_status` | 状态日志（带时间戳） | `log_status "开始构建"` |

#### 平台检测函数

| 函数 | 用途 | 返回值 |
|------|------|--------|
| `detect_os` | 检测操作系统 | `darwin`, `linux` |
| `detect_arch` | 检测架构 | `amd64`, `arm64`, `arm`, `s390x`, `ppc64le` |
| `detect_platform` | 获取平台标识 | `linux/amd64`, `darwin/arm64` |

#### 工具函数

| 函数 | 用途 | 示例 |
|------|------|------|
| `array_contains` | 检查数组元素 | `array_contains "item" "${array[@]}"` |
| `retry` | 重试命令 | `retry 3 curl https://example.com` |
| `command_exists` | 检查命令存在 | `command_exists docker` |
| `check_prerequisites` | 检查多个工具 | `check_prerequisites git docker jq` |
| `ensure_dir` | 确保目录存在 | `ensure_dir /tmp/myapp` |
| `get_abs_path` | 获取绝对路径 | `abs_path=$(get_abs_path file.txt)` |
| `ensure_temp_dir` | 创建临时目录 | `ensure_temp_dir` |
| `cleanup_temp_dir` | 清理临时目录 | 自动调用（trap EXIT） |
| `trap_add` | 添加 trap 处理器 | `trap_add cleanup EXIT` |
| `wait_for_url` | 等待 URL 响应 | `wait_for_url http://localhost:8080` |
| `version_compare` | 比较版本号 | `version_compare "1.2.3" "1.2.4"` |

## Kubernetes 脚本示例

### 概述

`kubernetes/` 目录包含来自 Kubernetes 项目的脚本示例，展示了**企业级 Shell 脚本的最佳实践**。

### 特点

- ✅ **模块化设计**：代码组织清晰，职责分明
- ✅ **完善的错误处理**：多层次的错误检查和恢复
- ✅ **详细的日志输出**：分级日志，便于调试
- ✅ **跨平台支持**：支持 Linux 和 macOS
- ✅ **并行处理**：高效的并发执行
- ✅ **完整的文档**：详细的注释和使用说明

### 推荐学习的脚本

1. **`hack/lib/init.sh`**
   - 学习点：库文件的组织和加载
   - 适用场景：大型项目的初始化

2. **`hack/lib/util.sh`**
   - 学习点：通用工具函数的实现
   - 适用场景：复用性高的工具函数

3. **`hack/lib/logging.sh`**
   - 学习点：企业级日志系统
   - 适用场景：需要详细日志的脚本

4. **`build/common.sh`**
   - 学习点：构建脚本的组织
   - 适用场景：CI/CD 构建流程

### 如何学习

1. **选择相关脚本**：根据你的需求选择相似的脚本
2. **阅读代码**：理解其设计模式和实现细节
3. **提取模式**：识别可复用的模式和函数
4. **应用到项目**：将学到的模式应用到你的脚本中

## k3s 脚本示例

### 概述

`k3s/` 目录包含来自 k3s 项目的脚本示例，展示了**轻量级、实用的脚本实现**。

### 特点

- ✅ **简洁明了**：代码简洁，易于理解
- ✅ **实用性强**：专注于解决实际问题
- ✅ **依赖少**：最小化外部依赖
- ✅ **性能优化**：高效的实现方式
- ✅ **易于维护**：代码结构清晰

### 推荐学习的脚本

1. **安装脚本**
   - 学习点：用户友好的安装流程
   - 适用场景：软件安装和部署

2. **配置脚本**
   - 学习点：配置文件的生成和管理
   - 适用场景：配置管理

3. **工具脚本**
   - 学习点：实用工具的实现
   - 适用场景：日常运维工具

### 如何学习

1. **对比学习**：对比 Kubernetes 和 k3s 的实现差异
2. **权衡取舍**：理解简洁性和完整性的平衡
3. **选择适合的风格**：根据项目规模选择合适的实现风格

## 学习路径建议

### 初学者

1. **从简单开始**：先学习 `lib/common.sh` 中的基础函数
2. **理解模式**：理解日志、错误处理、参数解析等基本模式
3. **实践应用**：在小项目中应用学到的函数和模式

### 中级开发者

1. **学习 k3s 脚本**：学习实用的脚本实现
2. **模块化设计**：学习如何组织大型脚本
3. **错误处理**：学习完善的错误处理机制

### 高级开发者

1. **学习 Kubernetes 脚本**：学习企业级脚本的最佳实践
2. **架构设计**：学习大型项目的脚本架构
3. **性能优化**：学习并行处理和性能优化技巧

## 常见问题

### Q: 为什么不能直接使用这些脚本？

**A**: 因为：
1. 这些脚本是为特定项目设计的，可能不适合你的需求
2. 直接使用会引入不必要的依赖
3. 子项目应该是独立的、可移植的

**正确做法**：学习其设计模式，复制需要的部分到你的项目中。

### Q: 如何选择参考哪个项目？

**A**: 
- **Kubernetes**：适合大型、复杂的项目，需要完善的错误处理和日志
- **k3s**：适合中小型项目，追求简洁和实用
- **lib/common.sh**：适合快速开始，提供基础的工具函数

### Q: 可以混合使用不同项目的模式吗？

**A**: 可以！根据你的需求选择最合适的实现方式。例如：
- 使用 Kubernetes 的日志系统
- 使用 k3s 的参数解析方式
- 使用 lib/common.sh 的工具函数

## 贡献

如果你发现了优秀的脚本示例，欢迎贡献到本目录：

1. 确保脚本来自开源项目
2. 添加适当的许可证说明
3. 提供学习指南和推荐阅读

---

**最后更新**: 2024-12

