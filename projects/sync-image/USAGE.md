# Dockeré•œåƒåŒæ­¥å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨
```bash
cd sync-image
./sync-images.sh
```

### æ¼”ç¤ºæ¨¡å¼ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰
```bash
# è¿è¡Œæ¼”ç¤ºæ¨¡å¼ï¼Œä¸æ‰§è¡Œå®é™…ç½‘ç»œæ“ä½œ
./sync-images-dry-run.sh
```

## ğŸ“‹ å¯ç”¨è„šæœ¬

| è„šæœ¬åç§° | ç”¨é€” | è¯´æ˜ |
|---------|------|------|
| `sync-images.sh` | ä¸»åŒæ­¥è„šæœ¬ | æ‰§è¡Œå®é™…çš„é•œåƒåŒæ­¥æ“ä½œ |
| `sync-images-dry-run.sh` | æ¼”ç¤ºè„šæœ¬ | æ¨¡æ‹ŸåŒæ­¥è¿‡ç¨‹ï¼Œç”¨äºæµ‹è¯• |
| `test-sync.sh` | æµ‹è¯•è„šæœ¬ | éªŒè¯å·¥å…·åŠŸèƒ½å’Œé…ç½® |
| `example.sh` | ç¤ºä¾‹è„šæœ¬ | äº¤äº’å¼ä½¿ç”¨æ¼”ç¤º |

## âš™ï¸ ä¸»è¦é…ç½®é€‰é¡¹

### åŸºæœ¬å‚æ•°
```bash
# æŒ‡å®šé•œåƒæ¸…å•æ–‡ä»¶
./sync-images.sh -f custom-imgs.txt

# æŒ‡å®šæºå’Œç›®æ ‡ä»“åº“
./sync-images.sh -s harbor.example.com -t localhost:5000

# è®¾ç½®é‡è¯•å‚æ•°
./sync-images.sh -r 5 -d 10
```

### é«˜çº§é€‰é¡¹
```bash
# å¯ç”¨é•œåƒå­˜åœ¨æ€§æ£€æŸ¥ï¼Œè·³è¿‡å·²å­˜åœ¨çš„é•œåƒï¼ˆèŠ‚çœæ—¶é—´ï¼‰
./sync-images.sh --check-exist

# ç»„åˆä½¿ç”¨å¤šä¸ªé€‰é¡¹ï¼ˆé»˜è®¤å¼ºåˆ¶åŒæ­¥æ‰€æœ‰é•œåƒï¼‰
./sync-images.sh -s harbor.example.com -t localhost:5000 -r 5
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. è„šæœ¬æ‰§è¡Œä¸­æ–­
**é—®é¢˜**: è„šæœ¬åœ¨å¼€å§‹åŒæ­¥æ—¶ç«‹å³ä¸­æ–­
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é»˜è®¤å·²å¯ç”¨å¼ºåˆ¶åŒæ­¥ï¼Œå¦‚æœä»æœ‰é—®é¢˜å¯ä»¥æ£€æŸ¥ç½‘ç»œè¿æ¥
./sync-images.sh
```

#### 2. ç½‘ç»œè¿æ¥é—®é¢˜
**é—®é¢˜**: æ— æ³•è¿æ¥åˆ°ç›®æ ‡Registry
**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿ç›®æ ‡Registryè¿è¡Œæ­£å¸¸
docker run -d -p 5000:5000 --name registry registry:2

# æˆ–ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼æµ‹è¯•è„šæœ¬åŠŸèƒ½
./sync-images-dry-run.sh
```

#### 3. skopeoæœªå®‰è£…
**é—®é¢˜**: `skopeo æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… skopeo`
**è§£å†³æ–¹æ¡ˆ**:
```bash
# macOS
brew install skopeo

# Ubuntu/Debian
sudo apt-get install skopeo

# CentOS/RHEL
sudo yum install skopeo
```

#### 4. æƒé™é—®é¢˜
**é—®é¢˜**: è„šæœ¬æ— æ³•æ‰§è¡Œ
**è§£å†³æ–¹æ¡ˆ**:
```bash
chmod +x sync-image/*.sh
```

## ğŸ“Š è¾“å‡ºè§£è¯»

### æ­£å¸¸è¾“å‡ºç¤ºä¾‹
```
==========================================
    Dockeré•œåƒåŒæ­¥è„šæœ¬ v1.0.0
==========================================

2025-08-28 10:30:00 [INFO] é…ç½®ä¿¡æ¯:
2025-08-28 10:30:00 [INFO]   æºä»“åº“: registry.bingosoft.net
2025-08-28 10:30:00 [INFO]   ç›®æ ‡ä»“åº“: 127.0.0.1:5000
2025-08-28 10:30:00 [INFO]   é•œåƒæ¸…å•: imgs.txt

è¿›åº¦: [=========================-------------------------] 50% (12/25)

2025-08-28 10:30:15 [SUCCESS] åŒæ­¥æˆåŠŸ: registry.bingosoft.net/...
```

### çŠ¶æ€è¯´æ˜
- `[INFO]` - ä¿¡æ¯æç¤º
- `[SUCCESS]` - æˆåŠŸæ“ä½œ
- `[WARNING]` - è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚é•œåƒå·²å­˜åœ¨ï¼‰
- `[ERROR]` - é”™è¯¯ä¿¡æ¯

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹é»˜è®¤é…ç½®
ç¼–è¾‘è„šæœ¬å¼€å¤´çš„é…ç½®å˜é‡ï¼š
```bash
SOURCE_REGISTRY="your-harbor.example.com"
TARGET_REGISTRY="your-local-registry:5000"
MAX_RETRIES=5
RETRY_DELAY=10
```

### é•œåƒæ¸…å•æ–‡ä»¶æ ¼å¼
```bash
# æ³¨é‡Šè¡Œ
registry.bingosoft.net/namespace/image:tag

# åˆ†ç»„
# base images
registry.bingosoft.net/bingokube/cluster-image/helm:v1.0.1

# ä¸´æ—¶ç¦ç”¨æŸä¸ªé•œåƒ
#registry.bingosoft.net/bingokube/cluster-image/disabled:v1.0.0
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. é¦–æ¬¡ä½¿ç”¨å»ºè®®
```bash
# 1. è¿è¡Œæµ‹è¯•éªŒè¯ç¯å¢ƒ
./test-sync.sh

# 2. ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ç†Ÿæ‚‰æµç¨‹
./sync-images-dry-run.sh

# 3. ç›´æ¥è¿è¡ŒåŒæ­¥ï¼ˆé»˜è®¤å¼ºåˆ¶åŒæ­¥ï¼Œç¡®ä¿æœ€æ–°ç‰ˆæœ¬ï¼‰
./sync-images.sh
```

### 2. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
```bash
# å¼ºåˆ¶åŒæ­¥æ‰€æœ‰é•œåƒï¼ˆé»˜è®¤è¡Œä¸ºï¼Œç¡®ä¿æœ€æ–°ç‰ˆæœ¬ï¼‰
./sync-images.sh

# å¢é‡åŒæ­¥ï¼ˆä»…åŒæ­¥ä¸å­˜åœ¨çš„é•œåƒï¼ŒèŠ‚çœæ—¶é—´ï¼‰
./sync-images.sh --check-exist

# å®šæœŸåŒæ­¥ï¼ˆå¯æ·»åŠ åˆ°crontabï¼‰
0 2 * * * cd /path/to/sync-image && ./sync-images.sh >> /var/log/sync-images.log 2>&1
```

### 3. å¤§æ‰¹é‡é•œåƒåŒæ­¥
```bash
# å¢åŠ é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿï¼ˆé»˜è®¤å¼ºåˆ¶åŒæ­¥ï¼‰
./sync-images.sh -r 10 -d 30
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç½‘ç»œä¼˜åŒ–**
   - ä½¿ç”¨æœ¬åœ°ç½‘ç»œçš„Registry
   - é…ç½®é•œåƒåŠ é€Ÿå™¨
   - åœ¨ç½‘ç»œç¨³å®šæ—¶æ®µæ‰§è¡ŒåŒæ­¥

2. **èµ„æºä¼˜åŒ–**
   - åˆ†æ‰¹åŒæ­¥å¤§é‡é•œåƒ
   - ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨
   - å®šæœŸæ¸…ç†æ— ç”¨é•œåƒ

3. **é”™è¯¯å¤„ç†**
   - å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶
   - è®¾ç½®ç›‘æ§å‘Šè­¦
   - å»ºç«‹é‡è¯•æœºåˆ¶

## ğŸ” æ—¥å¿—åˆ†æ

### æ—¥å¿—æ–‡ä»¶ä½ç½®
- ä¸»è„šæœ¬: `sync-images.log`
- æ¼”ç¤ºè„šæœ¬: `sync-dry-run.log`

### å¸¸ç”¨æ—¥å¿—åˆ†æå‘½ä»¤
```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f sync-images.log

# ç»Ÿè®¡åŒæ­¥ç»“æœ
grep -c "SUCCESS" sync-images.log
grep -c "ERROR" sync-images.log

# æŸ¥çœ‹å¤±è´¥çš„é•œåƒ
grep "ERROR.*åŒæ­¥å¤±è´¥" sync-images.log

# æ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶è¿‡å¤§ï¼‰
> sync-images.log
```

## ğŸ†˜ è·å–å¸®åŠ©

### æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
```bash
./sync-images.sh --help
./sync-images-dry-run.sh --help
```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
bash -x ./sync-images.sh

# æˆ–ä¸´æ—¶ä¿®æ”¹è„šæœ¬ç¬¬ä¸€è¡Œä¸º
#!/bin/bash -x
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. æ“ä½œç³»ç»Ÿç‰ˆæœ¬
2. skopeoç‰ˆæœ¬ (`skopeo --version`)
3. é”™è¯¯æ—¥å¿—å†…å®¹
4. ä½¿ç”¨çš„å‘½ä»¤å‚æ•°
5. ç½‘ç»œç¯å¢ƒæè¿°
